{
"name": "Azure_Audit_Stream_Analytics_Job_Should_Connect_To_Trusted_Inputs_And_Outputs",
"policy_id": "/providers/Microsoft.Authorization/policyDefinitions/fe8684d6-3c5b-45c0-a08b-fa92653c2e1c",
"display_name": "Azure Audit Stream Analytics Job Should Connect To Trusted Inputs And Outputs",
"description": "Ensure that Stream Analytics jobs do not have arbitrary Input or Output connections that are not defined in the allow-list. This checks that Stream Analytics jobs don't exfiltrate data by connecting to arbitrary sinks outside your organization.",
"category": "service",
"status": "active",
"content": "{\n    \"policyType\": \"BuiltIn\",\n    \"mode\": \"All\",\n    \"metadata\": {\n      \"policy_id\": \"/providers/Microsoft.Authorization/policyDefinitions/fe8684d6-3c5b-45c0-a08b-fa92653c2e1c\",\n      \"version\": \"1.1.0\",\n      \"category\": \"Stream Analytics\"\n    },\n    \"parameters\": {\n      \"effect\": {\n        \"type\": \"String\",\n        \"metadata\": {\n          \"displayName\": \"Effect\",\n          \"description\": \"The desired effect of the policy.\"\n        },\n        \"allowedValues\": [\n          \"Deny\",\n          \"Disabled\",\n          \"Audit\"\n        ],\n        \"defaultValue\": \"Audit\"\n      },\n      \"allowedEventHubNamespaces\": {\n        \"type\": \"Array\",\n        \"metadata\": {\n          \"displayName\": \"List of allowed Event Hub namespaces\"\n        },\n        \"defaultValue\": []\n      },\n      \"allowedSQLServers\": {\n        \"type\": \"Array\",\n        \"metadata\": {\n          \"displayName\": \"List of allowed SQL servers\"\n        },\n        \"defaultValue\": []\n      },\n      \"allowedStorageAccounts\": {\n        \"type\": \"Array\",\n        \"metadata\": {\n          \"displayName\": \"List of allowed storage accounts\"\n        },\n        \"defaultValue\": []\n      },\n      \"allowedCosmosAccounts\": {\n        \"type\": \"Array\",\n        \"metadata\": {\n          \"displayName\": \"List of allowed Cosmos DB accounts\"\n        },\n        \"defaultValue\": []\n      },\n      \"allowedAzureFunctionAccounts\": {\n        \"type\": \"Array\",\n        \"metadata\": {\n          \"displayName\": \"List of allowed Function Apps\"\n        },\n        \"defaultValue\": []\n      },\n      \"allowedIoTHubNamespaces\": {\n        \"type\": \"Array\",\n        \"metadata\": {\n          \"displayName\": \"List of allowed IoT Hubs\"\n        },\n        \"defaultValue\": []\n      },\n      \"allowedMLWebServiceEndpoints\": {\n        \"type\": \"Array\",\n        \"metadata\": {\n          \"displayName\": \"List of allowed ML Web Service endpoints\"\n        },\n        \"defaultValue\": []\n      }\n    },\n    \"policyRule\": {\n      \"if\": {\n        \"anyOf\": [\n          {\n            \"allOf\": [\n              {\n                \"field\": \"type\",\n                \"equals\": \"Microsoft.StreamAnalytics/streamingjobs/outputs\"\n              },\n              {\n                \"anyOf\": [\n                  {\n                    \"allOf\": [\n                      {\n                        \"field\": \"Microsoft.StreamAnalytics/streamingjobs/outputs/datasource.type\",\n                        \"equals\": \"Microsoft.EventHub/EventHub\"\n                      },\n                      {\n                        \"field\": \"Microsoft.StreamAnalytics/streamingjobs/outputs/datasource.Microsoft-ServiceBus-EventHub.serviceBusNamespace\",\n                        \"notIn\": \"[parameters('allowedEventHubNamespaces')]\"\n                      }\n                    ]\n                  },\n                  {\n                    \"allOf\": [\n                      {\n                        \"field\": \"Microsoft.StreamAnalytics/streamingjobs/outputs/datasource.type\",\n                        \"equals\": \"Microsoft.Sql/Server/Database\"\n                      },\n                      {\n                        \"field\": \"Microsoft.StreamAnalytics/streamingjobs/outputs/datasource.Microsoft-Sql-Server-Database.server\",\n                        \"notIn\": \"[parameters('allowedSQLServers')]\"\n                      }\n                    ]\n                  },\n                  {\n                    \"allOf\": [\n                      {\n                        \"field\": \"Microsoft.StreamAnalytics/streamingjobs/outputs/datasource.type\",\n                        \"equals\": \"Microsoft.Storage/Table\"\n                      },\n                      {\n                        \"field\": \"Microsoft.StreamAnalytics/streamingjobs/outputs/datasource.Microsoft-Storage-Table.accountName\",\n                        \"notIn\": \"[parameters('allowedStorageAccounts')]\"\n                      }\n                    ]\n                  },\n                  {\n                    \"allOf\": [\n                      {\n                        \"field\": \"Microsoft.StreamAnalytics/streamingjobs/outputs/datasource.type\",\n                        \"equals\": \"Microsoft.Storage/DocumentDB\"\n                      },\n                      {\n                        \"field\": \"Microsoft.StreamAnalytics/streamingjobs/outputs/datasource.Microsoft-Storage-DocumentDB.accountId\",\n                        \"notIn\": \"[parameters('allowedCosmosAccounts')]\"\n                      }\n                    ]\n                  },\n                  {\n                    \"allOf\": [\n                      {\n                        \"field\": \"Microsoft.StreamAnalytics/streamingjobs/outputs/datasource.type\",\n                        \"equals\": \"Microsoft.AzureFunction\"\n                      },\n                      {\n                        \"field\": \"Microsoft.StreamAnalytics/streamingjobs/outputs/datasource.Microsoft-AzureFunction.functionAppName\",\n                        \"notIn\": \"[parameters('allowedAzureFunctionAccounts')]\"\n                      }\n                    ]\n                  },\n                  {\n                    \"allOf\": [\n                      {\n                        \"field\": \"Microsoft.StreamAnalytics/streamingjobs/outputs/datasource.type\",\n                        \"equals\": \"Microsoft.Storage/Blob\"\n                      },\n                      {\n                        \"count\": {\n                          \"field\": \"Microsoft.StreamAnalytics/streamingjobs/outputs/datasource.Microsoft-Storage-Blob.storageAccounts[*]\",\n                          \"where\": {\n                            \"field\": \"Microsoft.StreamAnalytics/streamingjobs/outputs/datasource.Microsoft-Storage-Blob.storageAccounts[*].accountName\",\n                            \"notIn\": \"[parameters('allowedStorageAccounts')]\"\n                          }\n                        },\n                        \"greater\": 0\n                      }\n                    ]\n                  },\n                  {\n                    \"field\": \"Microsoft.StreamAnalytics/streamingjobs/outputs/datasource.type\",\n                    \"notIn\": [\n                      \"Microsoft.EventHub/EventHub\",\n                      \"Microsoft.Sql/Server/Database\",\n                      \"Microsoft.Storage/Table\",\n                      \"Microsoft.Storage/DocumentDB\",\n                      \"Microsoft.AzureFunction\",\n                      \"Microsoft.Storage/Blob\"\n                    ]\n                  }\n                ]\n              }\n            ]\n          },\n          {\n            \"allOf\": [\n              {\n                \"field\": \"type\",\n                \"equals\": \"Microsoft.StreamAnalytics/streamingjobs/inputs\"\n              },\n              {\n                \"anyOf\": [\n                  {\n                    \"allOf\": [\n                      {\n                        \"field\": \"Microsoft.StreamAnalytics/streamingjobs/inputs/Stream.datasource.type\",\n                        \"equals\": \"Microsoft.EventHub/EventHub\"\n                      },\n                      {\n                        \"field\": \"Microsoft.StreamAnalytics/streamingjobs/inputs/Stream.datasource.Microsoft-ServiceBus-EventHub.serviceBusNamespace\",\n                        \"notIn\": \"[parameters('allowedEventHubNamespaces')]\"\n                      }\n                    ]\n                  },\n                  {\n                    \"allOf\": [\n                      {\n                        \"field\": \"Microsoft.StreamAnalytics/streamingjobs/inputs/Stream.datasource.type\",\n                        \"equals\": \"Microsoft.Devices/IotHubs\"\n                      },\n                      {\n                        \"field\": \"Microsoft.StreamAnalytics/streamingjobs/inputs/Stream.datasource.Microsoft-Devices-IotHubs.iotHubNamespace\",\n                        \"notIn\": \"[parameters('allowedIoTHubNamespaces')]\"\n                      }\n                    ]\n                  },\n                  {\n                    \"allOf\": [\n                      {\n                        \"field\": \"Microsoft.StreamAnalytics/streamingjobs/inputs/Stream.datasource.type\",\n                        \"equals\": \"Microsoft.Sql/Server/Database\"\n                      },\n                      {\n                        \"field\": \"Microsoft.StreamAnalytics/streamingjobs/inputs/Reference.datasource.Microsoft-Sql-Server-Database.server\",\n                        \"notIn\": \"[parameters('allowedSqlServers')]\"\n                      }\n                    ]\n                  },\n                  {\n                    \"allOf\": [\n                      {\n                        \"field\": \"Microsoft.StreamAnalytics/streamingjobs/inputs/Stream.datasource.type\",\n                        \"equals\": \"Microsoft.Storage/Blob\"\n                      },\n                      {\n                        \"count\": {\n                          \"field\": \"Microsoft.StreamAnalytics/streamingjobs/inputs/Stream.datasource.Microsoft-Storage-Blob.storageAccounts[*]\",\n                          \"where\": {\n                            \"field\": \"Microsoft.StreamAnalytics/streamingjobs/inputs/Stream.datasource.Microsoft-Storage-Blob.storageAccounts[*].accountName\",\n                            \"notIn\": \"[parameters('allowedStorageAccounts')]\"\n                          }\n                        },\n                        \"greater\": 0\n                      }\n                    ]\n                  },\n                  {\n                    \"allOf\": [\n                      {\n                        \"field\": \"Microsoft.StreamAnalytics/streamingjobs/inputs/Reference.datasource.type\",\n                        \"equals\": \"Microsoft.Storage/Blob\"\n                      },\n                      {\n                        \"count\": {\n                          \"field\": \"Microsoft.StreamAnalytics/streamingjobs/inputs/Reference.datasource.Microsoft-Storage-Blob.storageAccounts[*]\",\n                          \"where\": {\n                            \"field\": \"Microsoft.StreamAnalytics/streamingjobs/inputs/Reference.datasource.Microsoft-Storage-Blob.storageAccounts[*].accountName\",\n                            \"notIn\": \"[parameters('allowedStorageAccounts')]\"\n                          }\n                        },\n                        \"greater\": 0\n                      }\n                    ]\n                  },\n                  {\n                    \"field\": \"Microsoft.StreamAnalytics/streamingjobs/inputs/Stream.datasource.type\",\n                    \"notIn\": [\n                      \"Microsoft.EventHub/EventHub\",\n                      \"Microsoft.Devices/IotHubs\",\n                      \"Microsoft.Sql/Server/Database\",\n                      \"Microsoft.Storage/Blob\"\n                    ]\n                  }\n                ]\n              }\n            ]\n          },\n          {\n            \"allOf\": [\n              {\n                \"field\": \"type\",\n                \"equals\": \"Microsoft.StreamAnalytics/streamingjobs/functions\"\n              },\n              {\n                \"anyOf\": [\n                  {\n                    \"allOf\": [\n                      {\n                        \"field\": \"Microsoft.StreamAnalytics/streamingjobs/functions[*].type\",\n                        \"equals\": \"Microsoft.MachineLearning/WebService\"\n                      },\n                      {\n                        \"field\": \"Microsoft.StreamAnalytics/streamingjobs/functions[*].binding.Microsoft-MachineLearning-WebService.endpoint\",\n                        \"notIn\": \"[parameters('allowedMLWebServiceEndpoints')]\"\n                      }\n                    ]\n                  },\n                  {\n                    \"field\": \"Microsoft.StreamAnalytics/streamingjobs/functions[*].type\",\n                    \"notIn\": [\n                      \"Microsoft.MachineLearning/WebService\",\n                      \"Microsoft.StreamAnalytics/JavascriptUdf\",\n                      \"Microsoft.StreamAnalytics/CLRUdf\"\n                    ]\n                  }\n                ]\n              }\n            ]\n          },\n          {\n            \"allOf\": [\n              {\n                \"field\": \"type\",\n                \"equals\": \"Microsoft.StreamAnalytics/streamingjobs\"\n              },\n              {\n                \"anyOf\": [\n                  {\n                    \"allOf\": [\n                      {\n                        \"field\": \"Microsoft.StreamAnalytics/streamingjobs/jobStorageAccount\",\n                        \"exists\": \"true\"\n                      },\n                      {\n                        \"field\": \"Microsoft.StreamAnalytics/streamingjobs/jobStorageAccount.accountName\",\n                        \"notIn\": \"[parameters('allowedStorageAccounts')]\"\n                      }\n                    ]\n                  }\n                ]\n              }\n            ]\n          }\n        ]\n      },\n      \"then\": {\n        \"effect\": \"[parameters('effect')]\"\n      }\n    }\n}",
"parameters": {},
"classification": "Security",
"sub_classification": "Application",
"service_resource": [
"Subscription"
],
"resource_type": "Subscription",
"severity": "high",
"type": [
"Cloud"
],
"services": [
"Azure"
],
"scope": "global",
"metadata": {},
"resources": [],
"is_temp": false,
"is_system_policy": false,
"recommendation": {
"name": "Azure_Audit_Stream_Analytics_Job_Should_Connect_To_Trusted_Inputs_And_Outputs",
"description": "Ensure that Stream Analytics jobs do not have arbitrary Input or Output connections that are not defined in the allow-list. This checks that Stream Analytics jobs don't exfiltrate data by connecting to arbitrary sinks outside your organization.",
"actions": []
},
"uri": "policy/azure_policy/global/azure/security/application/wacs7"
}