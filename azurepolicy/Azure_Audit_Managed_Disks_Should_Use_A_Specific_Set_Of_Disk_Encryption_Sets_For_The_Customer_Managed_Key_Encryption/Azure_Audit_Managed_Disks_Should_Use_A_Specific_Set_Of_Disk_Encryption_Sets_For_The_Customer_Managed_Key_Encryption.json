{
  "name": "Azure_Audit_Managed_Disks_Should_Use_A_Specific_Set_Of_Disk_Encryption_Sets_For_The_Customer_Managed_Key_Encryption",
  "policy_id": "/providers/Microsoft.Authorization/policyDefinitions/d461a302-a187-421a-89ac-84acdb4edc04",
  "display_name": "Azure Audit Managed Disks Should Use A Specific Set Of Disk Encryption Sets For The CME",
  "description": "Requiring a specific set of disk encryption sets to be used with managed disks give you control over the keys used for encryption at rest. You are able to select the allowed encrypted sets and all others are rejected when attached to a disk. Learn more at https://aka.ms/disks-cmk.",
  "category": "service",
  "status": "active",
  "content": "{\n    \"policyType\": \"BuiltIn\",\n    \"mode\": \"Indexed\",\n    \"description\": \"Requiring a specific set of disk encryption sets to be used with managed disks give you control over the keys used for encryption at rest. You are able to select the allowed encrypted sets and all others are rejected when attached to a disk. Learn more at https://aka.ms/disks-cmk.\",\n    \"metadata\": {\n      \"policy_id\": \"/providers/Microsoft.Authorization/policyDefinitions/d461a302-a187-421a-89ac-84acdb4edc04\",\n      \"category\": \"Compute\",\n      \"version\": \"2.0.0\"\n    },\n    \"parameters\": {\n      \"allowedEncryptionSets\": {\n        \"type\": \"Array\",\n        \"metadata\": {\n          \"displayName\": \"Allowed disk encryption set\",\n          \"description\": \"The list of allowed disk encryption sets for managed disks.\",\n          \"strongType\": \"Microsoft.Compute/diskEncryptionSets\"\n        }\n      },\n      \"effect\": {\n        \"type\": \"String\",\n        \"metadata\": {\n          \"displayName\": \"Effect\",\n          \"description\": \"Enable or disable the execution of the policy\"\n        },\n        \"allowedValues\": [\n          \"Audit\",\n          \"Deny\",\n          \"Disabled\"\n        ],\n        \"defaultValue\": \"Audit\"\n      }\n    },\n    \"policyRule\": {\n      \"if\": {\n        \"anyOf\": [\n          {\n            \"allOf\": [\n              {\n                \"field\": \"type\",\n                \"equals\": \"Microsoft.Compute/disks\"\n              },\n              {\n                \"field\": \"Microsoft.Compute/disks/managedBy\",\n                \"exists\": \"False\"\n              },\n              {\n                \"field\": \"Microsoft.Compute/disks/encryption.diskEncryptionSetId\",\n                \"notIn\": \"[parameters('allowedEncryptionSets')]\"\n              }\n            ]\n          },\n          {\n            \"allOf\": [\n              {\n                \"field\": \"type\",\n                \"equals\": \"Microsoft.Compute/virtualMachines\"\n              },\n              {\n                \"field\": \"Microsoft.Compute/virtualMachines/storageProfile.osDisk.managedDisk.diskEncryptionSet.id\",\n                \"notIn\": \"[parameters('allowedEncryptionSets')]\"\n              }\n            ]\n          },\n          {\n            \"allOf\": [\n              {\n                \"field\": \"type\",\n                \"equals\": \"Microsoft.Compute/virtualMachineScaleSets\"\n              },\n              {\n                \"field\": \"Microsoft.Compute/virtualMachineScaleSets/virtualMachineProfile.storageProfile.osDisk.managedDisk.diskEncryptionSet.id\",\n                \"notIn\": \"[parameters('allowedEncryptionSets')]\"\n              }\n            ]\n          },\n          {\n            \"allOf\": [\n              {\n                \"field\": \"type\",\n                \"equals\": \"Microsoft.Compute/virtualMachineScaleSets\"\n              },\n              {\n                \"count\": {\n                  \"field\": \"Microsoft.Compute/virtualMachineScaleSets/virtualMachineProfile.storageProfile.dataDisks[*]\"\n                },\n                \"greater\": 0\n              },\n              {\n                \"not\": {\n                  \"field\": \"Microsoft.Compute/virtualMachineScaleSets/virtualMachineProfile.storageProfile.dataDisks[*].managedDisk.diskEncryptionSet.id\",\n                  \"in\": \"[parameters('allowedEncryptionSets')]\"\n                }\n              }\n            ]\n          },\n          {\n            \"allOf\": [\n              {\n                \"field\": \"type\",\n                \"equals\": \"Microsoft.Compute/galleries/images/versions\"\n              },\n              {\n                \"not\": {\n                  \"field\": \"Microsoft.Compute/galleries/images/versions/publishingProfile.targetRegions[*].encryption.osDiskImage.diskEncryptionSetId\",\n                  \"in\": \"[parameters('allowedEncryptionSets')]\"\n                }\n              }\n            ]\n          },\n          {\n            \"allOf\": [\n              {\n                \"field\": \"type\",\n                \"equals\": \"Microsoft.Compute/galleries/images/versions\"\n              },\n              {\n                \"value\": \"[length(field('Microsoft.Compute/galleries/images/versions/storageProfile.dataDiskImages[*]'))]\",\n                \"greater\": 0\n              },\n              {\n                \"not\": {\n                  \"field\": \"Microsoft.Compute/galleries/images/versions/publishingProfile.targetRegions[*].encryption.dataDiskImages[*].diskEncryptionSetId\",\n                  \"in\": \"[parameters('allowedEncryptionSets')]\"\n                }\n              }\n            ]\n          },\n          {\n            \"allOf\": [\n              {\n                \"field\": \"type\",\n                \"equals\": \"Microsoft.Compute/images\"\n              },\n              {\n                \"field\": \"Microsoft.Compute/images/storageProfile.osDisk.diskEncryptionSet.id\",\n                \"notIn\": \"[parameters('allowedEncryptionSets')]\"\n              }\n            ]\n          },\n          {\n            \"allOf\": [\n              {\n                \"field\": \"type\",\n                \"equals\": \"Microsoft.Compute/images\"\n              },\n              {\n                \"value\": \"[length(field('Microsoft.Compute/images/storageProfile.dataDisks[*]'))]\",\n                \"greater\": 0\n              },\n              {\n                \"field\": \"Microsoft.Compute/images/storageProfile.dataDisks[*].diskEncryptionSet.id\",\n                \"notIn\": \"[parameters('allowedEncryptionSets')]\"\n              }\n            ]\n          }\n        ]\n      },\n      \"then\": {\n        \"effect\": \"[parameters('effect')]\"\n      }\n    }\n  }",
  "parameters": {},
  "classification": "Security",
  "sub_classification": "High",
  "service_resource": [
    "Virtual_Machines"
  ],
  "resource_type": "Virtual_Machines",
  "severity": "high",
  "type": [
    "Cloud"
  ],
  "services": [
    "Azure"
  ],
  "scope": "global",
  "metadata": {},
  "resources": [],
  "is_temp": false,
  "is_system_policy": false,
  "recommendation": {
    "name": "Azure_Audit_Managed_Disks_Should_Use_A_Specific_Set_Of_Disk_Encryption_Sets_For_The_Customer_Managed_Key_Encryption",
    "description": "Requiring a specific set of disk encryption sets to be used with managed disks give you control over the keys used for encryption at rest. You are able to select the allowed encrypted sets and all others are rejected when attached to a disk. Learn more at https://aka.ms/disks-cmk.",
    "actions": []
  },
  "uri": "policy/azure_policy/global/azure/compliance/others/dfnld"
}
